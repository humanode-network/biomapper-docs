import { Code, Tabs, Callout } from "nextra/components";

import { bridgedChains, stages, mainStageId } from "../../../../data/stages";
import { MDX } from "../../../../components/mdx";
import If from "../../../../components/If";
import DataLink from "../../../../components/DataLink";

{/* prettier-ignore-start */}

{/** @import {Props} from './content.types' */}

{/* prettier-ignore-end */}

[contract addresses]: /contract-addresses

<MDX.h1>{props.bridgedChain.generalDisplayName}</MDX.h1>

Integrating with Humanode Biomapper on {props.bridgedChain.generalDisplayName} network.

## Getting Started

First familiarize yourself with core concepts like
[Generations](/generations)
and [General Information](/integration/general-information) about the integrations.

Then, all you need to do is

- write your smart contract that integrated with Bridged Biomapper on
  {props.bridgedChain.generalDisplayName} network, and
- add the link to Biomapper UI on your frontend to let your users obtain
  the biomapping.

## Development

### Smart Contract

Use <DataLink link="biomapperSdkDocs">Biomapper SDK</DataLink> to get
the APIs for smart contracts.

You can use <Code>MockBridgedBiomapper</Code> contract for local development,
and testnet deployment of the <Code>BridgedBiomapper</Code> to real-world
testing.

See technical details at
the <DataLink link="biomapperSdkDocs">Biomapper SDK Docs</DataLink>.

### Frontend

Integrating on the frontend is as simple as adding a link to the Biomapper App.

<Callout type="info">
  Ignoring [generations](/generations) could lead to Sybil attacks.
</Callout>

Here is an example of how to check if a wallet is biomapped in the last generation
known to Biomapper on {props.bridgedChain.generalDisplayName}.

#### Get contract ABI

The proper way is to create ABI from `IBridgedBiomapperRead` interface in `@biomapper-sdk/core`.

Alternatively you can use these 2 functions:

<Tabs
  storageKey="web3lib"
  items={['Viem', 'Ethers v6']}>
>
  <Tabs.Tab>
    ```ts
    const biomapperAbi = parseAbi([
      "function generationsHead() external view returns (uint256)",
      "function lookupBiomappingPtr(address account, uint256 generationPtr) external view returns (uint256)",
    ]);
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```ts
    const biomapperAbi = [
      "function generationsHead() external view returns (uint256)",
      "function lookupBiomappingPtr(address account, uint256 generationPtr) external view returns (uint256)",
    ];
    ```
  </Tabs.Tab>
</Tabs>

#### Get contract address

Look up the [contract addresses] page for full contract addresses info.

<If condition={stages[mainStageId].bridged[props.bridgedChainId] !== null}>

For the Biomapper on {props.bridgedChain.generalDisplayName} Mainnet:

{/* prettier-ignore */}
<MDX.pre>
  <MDX.code>  const biomapperContractAddress = "{stages[mainStageId].bridged[props.bridgedChainId]?.addresses.bridgedBiomapper}";</MDX.code>
</MDX.pre>

</If>

For the Biomapper on {stages["testnet5"].bridged[props.bridgedChainId]?.displayName}:

{/* prettier-ignore */}
<MDX.pre>
  <MDX.code>  const biomapperContractAddress = "{stages["testnet5"].bridged[props.bridgedChainId]?.addresses.bridgedBiomapper}";</MDX.code>
</MDX.pre>

#### Get current biomapping generation

<Tabs
  storageKey="web3lib"
  items={['Viem', 'Ethers 6']}>
>
  <Tabs.Tab>
    See more about `readContract` function on https://viem.sh/docs/contract/readContract.

    ```ts
    const lastKnownGeneration = await publicClient.readContract({
      address: biomapperContractAddress,
      abi: biomapperAbi,
      functionName: "generationsHead",
    });
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    See more about how to read Ethers contracts on https://docs.ethers.org/v6/getting-started/#cid_56.

    ```ts
    // Prepare re-usable contract definition.
    const biomapperContract = new Contract(biomapperContractAddress, biomapperAbi, provider);

    const lastKnownGeneration = await biomapperContract.generationsHead();

    ```

  </Tabs.Tab>
</Tabs>

#### Get biomapping status in the last known generation

To get biomapping status for some address `addressToCheck` in the last known generation

<Tabs
  storageKey="web3lib"
  items={['Viem', 'Ethers 6']}>
>
  <Tabs.Tab>
    ```ts
    const biomappingPtrInLastKnownGeneration = await publicClient.readContract({
      address: biomapperContractAddress,
      abi: biomapperAbi,
      functionName: "lookupBiomappingPtr",
      args: [addressToCheck, lastKnownGeneration],
    });
    ```

  </Tabs.Tab>
  <Tabs.Tab>
    ```ts
    const biomappingPtrInLastKnownGeneration =
      await biomapperContract.lookupBiomappingPtr(
        addressToCheck,
        lastKnownGeneration
      );

    ```

  </Tabs.Tab>
</Tabs>

{/* prettier-ignore-start */}

`biomappingPtrInLastKnownGeneration` is the block number on
<If condition={stages[mainStageId].bridged[props.bridgedChainId] !== null}>Humanode Mainnet</If>
<If condition={stages[mainStageId].bridged[props.bridgedChainId] !== null && stages["testnet5"].bridged[props.bridgedChainId] !== null}>or</If>
<If condition={stages["testnet5"].bridged[props.bridgedChainId] !== null}>Humanode Testnet 5</If>
of biomapping tx in the last known generation for specified address,
or zero if such address is not biomapped.

{/* prettier-ignore-end */}

```ts
const biomappingStatus = biomappingPtrInLastKnownGeneration !== 0n;
```

## Rollout

<If condition={stages[mainStageId].bridged[props.bridgedChainId] !== null}>

When you are ready, deploy your smart contract
to {props.bridgedChain.generalDisplayName} and connect it to
the Humanode Bridged Biomapper
on <b>{stages[mainStageId].bridged[props.bridgedChainId]?.displayName}</b>
(see [contract addresses]).

Don't forget to update the link to Biomapper App your the frontend to mainnet Biomapper App.

</If>

<If condition={stages[mainStageId].bridged[props.bridgedChainId] === null}>

The mainnet for this chain is not supported yet, so you can skip the rollout.

</If>

## After Rollout

If you'd like your app to be listed in the Biomapper App talk to us.
